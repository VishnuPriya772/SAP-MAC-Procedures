ALTER PROCEDURE [dbo].[GetProductionOrderStatus]
    @PlantID VARCHAR(50) = NULL,
    @StorageCode VARCHAR(50) = NULL
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        TP.Prdord_ID,
        TP.Plant_ID,
        MP.Plant_Code AS TP_Plant_Code,
        TP.Order_Type,
        TP.Supv_ID,
        CONCAT(MS.Sup_Code, ' - ', MS.Sup_Name) AS Sup_Name,
        MSP.Plant_Code AS Supv_Plant_Code,
        TP.Order_No,
        FORMAT(TP.Order_Created_Date, 'dd-MM-yyyy') AS Order_Date,
        FORMAT(TP.Order_Closed_Date, 'dd-MM-yyyy') AS Issued_Date,
        TP.Issue_Duration_Time,
        TP.Material_No,
        TP.Material_Description,
        TP.Order_Qty,

        -- Get Storage_Code based on Sloc_Code from creation table
        ST.Storage_Code AS Creation_Storage_Code,
        ST.SLoc_Name AS Creation_SLoc_Name,
		DATEDIFF(MINUTE, OC.Created_On, GETDATE()) AS Delay_Time

    FROM 
        Trn_prod_order_status TP

    -- Join Plant Info
    INNER JOIN Mst_Plant MP ON TP.Plant_ID = MP.Plant_ID

    -- Join Supervisor Info
    LEFT JOIN Mst_SupvCode MS ON TP.Supv_ID = MS.Supv_ID
    LEFT JOIN Mst_Plant MSP ON MS.Plant_ID = MSP.Plant_ID

    -- OUTER APPLY to get only 1 matching row from Order Creation
    OUTER APPLY (
        SELECT TOP 1 * 
        FROM TrnSap_Order_creation OC 
        WHERE OC.Order_No = TP.Order_No
        ORDER BY OC.Created_On DESC -- Or by any preferred column
    ) OC

    -- Join Storage Location Table using Sloc_Code
    LEFT JOIN Mst_Storage_Location ST ON OC.Sloc_Code = ST.Storage_Code AND ST.Active_Status = 1

    WHERE 
        TP.Order_Type = 'New'
        AND (@PlantID IS NULL OR TP.Plant_ID = @PlantID)
        AND (@StorageCode IS NULL OR ST.Storage_Code = @StorageCode);
END;
