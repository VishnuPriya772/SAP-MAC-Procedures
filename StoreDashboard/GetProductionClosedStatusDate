CREATE OR ALTER PROCEDURE GetProductionClosedStatusDate
    @Sloc_Code VARCHAR(50) = NULL , -- Optional filter parameter
	  @fromDate DATE = NULL,
    @toDate DATE = NULL
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
	    TP.Prdord_ID,
        SC.Supv_ID,
        CONCAT(SC.Sup_Code, ' - ', SC.Sup_Name) AS Sup_Name,
        COUNT(TP.Prdord_ID) AS [No.Of Orders],
        COUNT(CASE WHEN TP.Order_Type = 'Closed' THEN 1 END) AS [No Order Close],
        COUNT(CASE WHEN TP.Ontime_or_Delay = 'Ontime' THEN 1 END) AS [Issue Posted on Time],
        COUNT(CASE WHEN TP.Ontime_or_Delay = 'Delay' THEN 1 END) AS [Issue Posted Delay]
    FROM Trn_prod_order_status TP

    -- Join Supervisor
    LEFT JOIN Mst_SupvCode SC ON TP.Supv_ID = SC.Supv_ID

    -- Join to TrnSap_Order_creation to get Sloc_Code
    LEFT JOIN (
        SELECT Order_No, Sloc_Code
        FROM (
            SELECT *,
                   ROW_NUMBER() OVER (PARTITION BY Order_No ORDER BY Created_On DESC) AS rn
            FROM TrnSap_Order_creation
        ) OC
        WHERE rn = 1
    ) OC ON TP.Order_No = OC.Order_No

    WHERE TP.Order_Type = 'Closed'
      AND (@Sloc_Code IS NULL OR OC.Sloc_Code = @Sloc_Code)
	  AND (
            (@fromDate IS NULL AND @toDate IS NULL) OR
            (CAST(TP.Order_Closed_Date AS DATE) BETWEEN @fromDate AND @toDate)
        )
    GROUP BY SC.Supv_ID, SC.Sup_Code, SC.Sup_Name,TP.Prdord_ID;
END;
