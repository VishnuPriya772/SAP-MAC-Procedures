SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[UpdateApprovalStatusForInwards]
    @Inward_ID INT,
    @UserID INT,
    @RoleID INT,
    @Approver_Comment VARCHAR(500)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @InwardType VARCHAR(10);
    SELECT @InwardType = Inward_Type FROM Trn_Inward_Old_Invoice WHERE Inward_ID = @Inward_ID;

    --------------------
    -- Purchase ('D') --
    --------------------
    IF @InwardType = 'D'
    BEGIN
        UPDATE Trn_Inward_Old_Invoice
        SET Approver_1 = @RoleID
        WHERE Inward_ID = @Inward_ID AND Approver_1 IS NULL;

        IF EXISTS (
            SELECT 1 FROM Trn_Inward_Old_Invoice
            WHERE Inward_ID = @Inward_ID AND Approval1_Status = 'Waiting'
        )
        BEGIN
            UPDATE Trn_Inward_Old_Invoice
            SET 
                Approval1_Status = 'Approved',
                Status = 'Approved',
                Approver1_Comment = @Approver_Comment,
                Modified_By = @UserID,
                Modified_On = GETDATE()
            WHERE Inward_ID = @Inward_ID;
        END
        ELSE IF EXISTS (
            SELECT 1 FROM Trn_Inward_Old_Invoice
            WHERE Inward_ID = @Inward_ID AND Approval1_Status = 'Approved' AND Approval2_Status = 'Waiting'
        )
        BEGIN
            UPDATE Trn_Inward_Old_Invoice
            SET 
                Approval2_Status = 'Approved',
                Approver2_Comment = @Approver_Comment,
                Modified_By = @UserID,
                Modified_On = GETDATE()
            WHERE Inward_ID = @Inward_ID;
        END
    END

    ------------------
    -- Service ('s') --
    ------------------
    ELSE IF @InwardType = 's'
    BEGIN
        UPDATE Trn_Inward_Old_Invoice
        SET Approver_1 = @RoleID
        WHERE Inward_ID = @Inward_ID 

        IF EXISTS (
            SELECT 1 FROM Trn_Inward_Old_Invoice
            WHERE Inward_ID = @Inward_ID AND Approval1_Status = 'Waiting'
        )
        BEGIN
            UPDATE Trn_Inward_Old_Invoice
            SET 
                Approval1_Status = 'Approved',
                Approval2_Status = 'Waiting',
                Status = 'Level1 Approved',
                Approver1_Comment = @Approver_Comment,
                Modified_By = @UserID,
                Modified_On = GETDATE()
            WHERE Inward_ID = @Inward_ID;
        END
        ELSE IF EXISTS (
            SELECT 1 FROM Trn_Inward_Old_Invoice
            WHERE Inward_ID = @Inward_ID AND Approval1_Status = 'Approved' AND Approval2_Status = 'Waiting'
        )
        BEGIN
            UPDATE Trn_Inward_Old_Invoice
            SET 
                Approval2_Status = 'Approved',
                Approval3_Status = 'Waiting',
                Status = 'Level2 Approved',
                Approver2_Comment = @Approver_Comment,
                Modified_By = @UserID,
                Modified_On = GETDATE()
            WHERE Inward_ID = @Inward_ID;
        END
        ELSE IF EXISTS (
            SELECT 1 FROM Trn_Inward_Old_Invoice
            WHERE Inward_ID = @Inward_ID AND Approval2_Status = 'Approved' AND Approval3_Status = 'Waiting'
        )
        BEGIN
            UPDATE Trn_Inward_Old_Invoice
            SET 
                Approval3_Status = 'Approved',
                Status = 'Level3 Approved',
                Approver3_Comment = @Approver_Comment,
                Modified_By = @UserID,
                Modified_On = GETDATE()
            WHERE Inward_ID = @Inward_ID;
        END
    END

    ------------------------
    -- Engineering ('E') --
    ------------------------
    ELSE IF @InwardType = 'E'
    BEGIN
        UPDATE Trn_Inward_Old_Invoice
        SET Approver_1 = @RoleID
        WHERE Inward_ID = @Inward_ID ;
        IF EXISTS (
            SELECT 1 FROM Trn_Inward_Old_Invoice
            WHERE Inward_ID = @Inward_ID AND Approval1_Status = 'Waiting'
        )
        BEGIN
            UPDATE Trn_Inward_Old_Invoice
            SET 
                Approval1_Status = 'Approved',
                Approval2_Status = 'Waiting',
                Status = 'Level1 Approved',
                Approver1_Comment = @Approver_Comment,
                Modified_By = @UserID,
                Modified_On = GETDATE()
            WHERE Inward_ID = @Inward_ID;
        END
        ELSE IF EXISTS (
            SELECT 1 FROM Trn_Inward_Old_Invoice
            WHERE Inward_ID = @Inward_ID AND Approval1_Status = 'Approved' AND Approval2_Status = 'Waiting'
        )
        BEGIN
            UPDATE Trn_Inward_Old_Invoice
            SET 
                Approval2_Status = 'Approved',
                Approval3_Status = 'Waiting',
                Status = 'Level2 Approved',
                Approver2_Comment = @Approver_Comment,
                Modified_By = @UserID,
                Modified_On = GETDATE()
            WHERE Inward_ID = @Inward_ID;
        END
        ELSE IF EXISTS (
            SELECT 1 FROM Trn_Inward_Old_Invoice
            WHERE Inward_ID = @Inward_ID AND Approval2_Status = 'Approved' AND Approval3_Status = 'Waiting'
        )
        BEGIN
            UPDATE Trn_Inward_Old_Invoice
            SET 
                Approval3_Status = 'Approved',
                Status = 'Level3 Approved',
                Approver3_Comment = @Approver_Comment,
                Modified_By = @UserID,
                Modified_On = GETDATE()
            WHERE Inward_ID = @Inward_ID;
        END
    END
END
GO
